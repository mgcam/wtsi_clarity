ALTER TABLE `study_users`       DROP FOREIGN KEY `study_users_study_fk`;
ALTER TABLE `iseq_flowcell`     DROP FOREIGN KEY `iseq_flowcell_sample_fk`, \
                                DROP FOREIGN KEY `iseq_flowcell_study_fk`;
ALTER TABLE `flgen_plate`       DROP FOREIGN KEY `flgen_plate_sample_fk`, \
                                DROP FOREIGN KEY `flgen_plate_study_fk`;
ALTER TABLE `iseq_run_status`   DROP FOREIGN KEY `iseq_run_status_rsd_fk`;
ALTER TABLE `iseq_run_lane_metrics` DROP FOREIGN KEY `iseq_rl_metrics_flc_fk`;
ALTER TABLE `iseq_product_metrics`  DROP FOREIGN KEY `iseq_pr_metrics_flc_fk`, \
                                    DROP FOREIGN KEY `iseq_pr_metrics_lm_fk`;

DROP TABLE IF EXISTS `study`;
CREATE TABLE `study` (
  `id_study_tmp` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'Internal to this database id, value can change',
  `id_lims` varchar(10) NOT NULL COMMENT 'LIM system identifier, e.g. GCLP-CLARITY, SEQSCAPE',
  `uuid_study_lims` varchar(255) DEFAULT NULL COMMENT 'LIMS-specific study uuid',
  `id_study_lims` varchar(255) NOT NULL COMMENT 'LIMS-specific study identifier',
  `last_updated` datetime NOT NULL COMMENT 'Timestamp of last update',
  `name` varchar(255) DEFAULT NULL,
  `reference_genome` varchar(255) DEFAULT NULL,
  `ethically_approved` tinyint(1) DEFAULT NULL,
  `faculty_sponsor` varchar(255) DEFAULT NULL,
  `state` varchar(50) DEFAULT NULL,
  `study_type` varchar(50) DEFAULT NULL,
  `abstract` text,
  `abbreviation` varchar(255) DEFAULT NULL,
  `accession_number` varchar(50) DEFAULT NULL,
  `description` text,
  `contains_human_dna` varchar(255) DEFAULT NULL,
  `contaminated_human_dna` varchar(255) DEFAULT NULL,
  `data_release_strategy` varchar(255) DEFAULT NULL,
  `data_release_sort_of_study` varchar(255) DEFAULT NULL,
  `ena_project_id` varchar(255) DEFAULT NULL,
  `study_title` varchar(255) DEFAULT NULL,
  `study_visibility` varchar(255) DEFAULT NULL,
  `ega_dac_accession_number` varchar(255) DEFAULT NULL,
  `array_express_accession_number` varchar(255) DEFAULT NULL,
  `ega_policy_accession_number` varchar(255) DEFAULT NULL,
  `data_release_timing` varchar(255) DEFAULT NULL,
  `data_release_delay_period` varchar(255) DEFAULT NULL,
  `data_release_delay_reason` varchar(255) DEFAULT NULL,
  `remove_x_and_autosomes` tinyint(1) NOT NULL DEFAULT '0',
  `alignments_in_bam` tinyint(1) NOT NULL DEFAULT '1',
  `separate_y_chromosome_data` tinyint(1) NOT NULL DEFAULT '0',
  `data_access_group` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id_study_tmp`),
  UNIQUE KEY `study_id_study_lims_index` (`id_study_lims`),
  KEY `study_uuid_study_lims_index` (`uuid_study_lims`),
  KEY `study_accession_number_index` (`accession_number`),
  KEY `study_name_index` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `sample`;
CREATE TABLE `sample` (
  `id_sample_tmp` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'Internal to this database id, value can change',
  `id_lims` varchar(10) NOT NULL COMMENT 'LIM system identifier, e.g. CLARITY-GCLP, SEQSCAPE',
  `uuid_sample_lims` varchar(255) DEFAULT NULL COMMENT 'LIMS-specific sample uuid',
  `id_sample_lims` varchar(255) NOT NULL COMMENT 'LIMS-specific sample identifier',
  `last_updated` datetime NOT NULL COMMENT 'Timestamp of last update',
  `name` varchar(255) DEFAULT NULL,
  `reference_genome` varchar(255) DEFAULT NULL,
  `organism` varchar(255) DEFAULT NULL,
  `accession_number` varchar(50) DEFAULT NULL,
  `common_name` varchar(255) DEFAULT NULL,
  `description` text,
  `taxon_id` int(6) unsigned DEFAULT NULL,
  `father` varchar(255) DEFAULT NULL,
  `mother` varchar(255) DEFAULT NULL,
  `replicate` varchar(255) DEFAULT NULL,
  `ethnicity` varchar(255) DEFAULT NULL,
  `gender` varchar(20) DEFAULT NULL,
  `cohort` varchar(255) DEFAULT NULL,
  `country_of_origin` varchar(255) DEFAULT NULL,
  `geographical_region` varchar(255) DEFAULT NULL,
  `control` tinyint(1) DEFAULT NULL,
  `supplier_name` varchar(255) DEFAULT NULL,
  `public_name` varchar(255) DEFAULT NULL,
  `sample_visibility` varchar(255) DEFAULT NULL,
  `strain` varchar(255) DEFAULT NULL,
  `consent_withdrawn` tinyint(1) NOT NULL DEFAULT '0',
  `donor_id` varchar(255) DEFAULT NULL,
  PRIMARY KEY (`id_sample_tmp`),
  UNIQUE KEY `sample_id_sample_lims_index` (`id_sample_lims`),
  KEY `sample_uuid_sample_lims_index` (`uuid_sample_lims`),
  KEY `sample_accession_number_index` (`accession_number`),
  KEY `sample_name_index` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `study_users`;
CREATE TABLE `study_users` (
  `id_study_users_tmp` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'Internal to this database id, value can change',
  `id_study_tmp` int(11) unsigned NOT NULL COMMENT 'Study id, see "study.id_study_tmp"',
  `last_updated` datetime NOT NULL COMMENT 'Timestamp of last update',
  `role` varchar(255)  DEFAULT NULL,
  `login` varchar(255) DEFAULT NULL,
  `email` varchar(255) DEFAULT NULL,
  `name` varchar(255)  DEFAULT NULL,
  PRIMARY KEY (`id_study_users_tmp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `iseq_flowcell`;
CREATE TABLE `iseq_flowcell` (
  `id_iseq_flowcell_tmp` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'Internal to this database id, value can change',
  `id_sample_tmp` int(11) unsigned NOT NULL COMMENT 'Sample id, see "sample.id_sample_tmp"',
  `id_study_tmp` int(11) unsigned NOT NULL COMMENT 'Study id, see "study.id_study_tmp"',
  `id_lims` varchar(10) NOT NULL COMMENT 'LIM system identifier, e.g. CLARITY-GCLP, SEQSCAPE',
  `flowcell_barcode` varchar(15) DEFAULT NULL COMMENT 'Manufacturer flowcell barcode or other identifier',
  PRIMARY KEY (`id_iseq_flowcell_tmp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `flgen_plate`;
CREATE TABLE `flgen_plate` (
  `id_flgen_plate_tmp` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'Internal to this database id, value can change',
  `id_sample_tmp` int(11) unsigned NOT NULL COMMENT 'Sample id, see "sample.id_sample_tmp"',
  `id_study_tmp`  int(11) unsigned NOT NULL COMMENT 'Study id, see "study.id_study_tmp"',
  `id_lims` varchar(10) NOT NULL COMMENT 'LIM system identifier, e.g. CLARITY-GCLP, SEQSCAPE',
  `plate_barcode` int(13) unsigned NOT NULL COMMENT 'Manufacturer (Fluidigm) chip barcode',
  PRIMARY KEY (`id_flgen_plate_tmp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `iseq_run_lane_metrics`;
CREATE TABLE `iseq_run_lane_metrics` (
  `id_iseq_lane_metrics_tmp` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'Internal to this database id, value can change',
  `id_iseq_flowcell_tmp` int(11) unsigned NOT NULL COMMENT 'Flowcell id, see "iseq_flowcell.id_iseq_flowcell_tmp"',
  PRIMARY KEY (`id_iseq_lane_metrics_tmp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `iseq_product_metrics`;
CREATE TABLE `iseq_product_metrics` (
  `id_iseq_pr_metrics_tmp` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'Internal to this database id, value can change',
  `id_iseq_lane_metrics_tmp` int(11) unsigned NOT NULL COMMENT 'Lane metrics id, see "iseq_run_lane_metrics.id_iseq_lane_metrics_tmp"',
  `id_iseq_flowcell_tmp` int(11) unsigned NOT NULL COMMENT 'Flowcell id, see "iseq_flowcell.id_iseq_flowcell_tmp"',
  PRIMARY KEY (`id_iseq_pr_metrics_tmp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `iseq_run_status_dict`;
CREATE TABLE `iseq_run_status_dict` (
  `id_run_status_dict` int(11) unsigned NOT NULL,
  `description` varchar(64) NOT NULL,
  `iscurrent` tinyint(3) unsigned NOT NULL,
  `temporal_index` smallint(5) unsigned DEFAULT NULL,
  PRIMARY KEY (`id_run_status_dict`),
  KEY `iseq_run_status_dict_description_index` (`description`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

DROP TABLE IF EXISTS `iseq_run_status`;
CREATE TABLE `iseq_run_status` (
  `id_run_status` int(11) unsigned NOT NULL,
  `id_run` bigint(20) unsigned NOT NULL COMMENT 'NPG run identifier',
  `date` datetime NOT NULL COMMENT 'Status timestamp',
  `id_run_status_dict` int(11) unsigned NOT NULL COMMENT 'Status identifier, see iseq_run_status_dict.id_run_status_dict',
  `id_user` bigint(20) unsigned NOT NULL COMMENT 'Operator usename',
  `iscurrent` tinyint(1) NOT NULL COMMENT 'Boolean flag, 1 is the status is current, 0 otherwise',
  PRIMARY KEY (`id_run_status`)
) ENGINE=InnoDB  DEFAULT CHARSET=utf8;


ALTER TABLE `study_users` \
  ADD CONSTRAINT study_users_study_fk \
  FOREIGN KEY (`id_study_tmp`) REFERENCES `study` (`id_study_tmp`) \
  ON DELETE NO ACTION ON UPDATE NO ACTION;

ALTER TABLE `iseq_flowcell` \
  ADD CONSTRAINT `iseq_flowcell_sample_fk` \
  FOREIGN KEY (`id_sample_tmp`) REFERENCES `sample` (`id_sample_tmp`) \
  ON DELETE NO ACTION ON UPDATE NO ACTION, \
  ADD CONSTRAINT `iseq_flowcell_study_fk` \
  FOREIGN KEY (`id_study_tmp`) REFERENCES `study` (`id_study_tmp`) \
  ON DELETE NO ACTION ON UPDATE NO ACTION;

ALTER TABLE `flgen_plate` \
  ADD CONSTRAINT `flgen_plate_sample_fk` \
  FOREIGN KEY (`id_sample_tmp`) REFERENCES `sample` (`id_sample_tmp`) \
  ON DELETE NO ACTION ON UPDATE NO ACTION, \
  ADD CONSTRAINT `flgen_plate_study_fk` \
  FOREIGN KEY (`id_study_tmp`) REFERENCES `study` (`id_study_tmp`) \
  ON DELETE NO ACTION ON UPDATE NO ACTION;

ALTER TABLE `iseq_run_status` \
  ADD CONSTRAINT `iseq_run_status_rsd_fk` \
  FOREIGN KEY (`id_run_status_dict`) REFERENCES `iseq_run_status_dict` (`id_run_status_dict`) \
  ON DELETE NO ACTION ON UPDATE NO ACTION;

ALTER TABLE `iseq_run_lane_metrics` \
  ADD CONSTRAINT `iseq_rl_metrics_flc_fk` \
  FOREIGN KEY (`id_iseq_flowcell_tmp`) REFERENCES `iseq_flowcell` (`id_iseq_flowcell_tmp`) \
  ON DELETE NO ACTION ON UPDATE NO ACTION;

ALTER TABLE `iseq_product_metrics` \
  ADD CONSTRAINT `iseq_pr_metrics_flc_fk` \
  FOREIGN KEY (`id_iseq_flowcell_tmp`) REFERENCES `iseq_flowcell` (`id_iseq_flowcell_tmp`) \
  ON DELETE NO ACTION ON UPDATE NO ACTION,
  ADD CONSTRAINT `iseq_pr_metrics_lm_fk` \
  FOREIGN KEY (`id_iseq_lane_metrics_tmp`) REFERENCES `iseq_run_lane_metrics` (`id_iseq_lane_metrics_tmp`) \
  ON DELETE NO ACTION ON UPDATE NO ACTION;
